<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>å¤–éƒ¨å¹³å°æ‹‰å– & é¢„è§ˆ & å…¥åº“ï¼ˆingest-externalï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    (() => {
      const pref = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      if (pref === 'dark') document.documentElement.classList.add('dark');
      window.__toggleTheme = () => {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
      };
    })();
  </script>
  <style>
    *{scrollbar-width:thin}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}.dark ::-webkit-scrollbar-thumb{background:#334155}
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900 dark:bg-zinc-900 dark:text-zinc-50 min-h-screen">
  <div class="max-w-6xl mx-auto p-4 space-y-4">
    <header class="flex items-center gap-3">
      <h1 class="text-xl font-semibold">å¤–éƒ¨å¹³å°æ‹‰å– & é¢„è§ˆ & å…¥åº“</h1>
      <button class="ml-auto p-2 rounded hover:bg-zinc-100 dark:hover:bg-zinc-800" onclick="__toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
    </header>

    <!-- è®¾ç½®åŒº -->
    <section class="rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-3 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
        <div class="md:col-span-3">
          <label class="block text-sm mb-1">API Baseï¼ˆé»˜è®¤ /AppleStockCheckerï¼‰</label>
          <input id="apiBase" type="text" placeholder="/AppleStockChecker" class="w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 outline-none"/>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Bearer Tokenï¼ˆ/AppleStockChecker/auth/token/ çš„ accessï¼‰</label>
          <input id="token" type="password" placeholder="eyJ..." class="w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 outline-none"/>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">æ‰§è¡Œæ–¹å¼</label>
          <div class="flex items-center gap-4 text-sm">
            <label class="inline-flex items-center gap-2"><input type="radio" name="mode" value="dry" checked> æ¨¡æ‹Ÿæ‰§è¡Œè½åº“ï¼ˆdry_runï¼‰</label>
            <label class="inline-flex items-center gap-2"><input type="radio" name="mode" value="real"> å®é™…æ‰§è¡Œè½åº“</label>
          </div>
        </div>
        <div class="md:col-span-3">
          <label class="block text-sm mb-1">ä½¿ç”¨ settings é¢„ç½®çš„æ¥æº namesï¼ˆé€—å·åˆ†éš”ï¼‰</label>
          <input id="names" type="text" placeholder="ä¾‹å¦‚ï¼šshop8, sample_aï¼ˆç•™ç©º=ä½¿ç”¨å…¨éƒ¨é¢„ç½®ï¼‰" class="w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 outline-none"/>
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">æˆ–ç›´æ¥ç²˜è´´ sources JSONï¼ˆä¼˜å…ˆä½¿ç”¨æ­¤é¡¹ï¼‰</label>
        <textarea id="sourcesJson" rows="5" placeholder='ä¾‹å¦‚ï¼š
{
  "sources": [
    {"name":"shop8","url":"https://platform.example.com/shop8.csv"},
    {"name":"sample_a","url":"https://platform.example.com/a.csv","headers":{"X-API-Key":"..."}}
  ]
}' class="w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 outline-none font-mono text-xs"></textarea>
      </div>

      <div class="flex items-center gap-2">
        <button id="runBtn" class="px-4 py-2 rounded-lg bg-black text-white dark:bg-white dark:text-black">æ‹‰å–å¹¶æŸ¥çœ‹</button>
        <button id="saveBtn" class="px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800">ä¿å­˜è®¾ç½®</button>
        <span id="loading" class="text-sm text-zinc-500 hidden">è¿›è¡Œä¸­â€¦</span>
        <span id="statusMsg" class="text-sm text-zinc-600 dark:text-zinc-400 ml-auto"></span>
      </div>
      <div class="h-2 bg-zinc-200 dark:bg-zinc-800 rounded overflow-hidden"><div id="progressBar" class="h-full bg-black dark:bg-white w-0"></div></div>
    </section>

    <!-- ç»“æœ -->
    <section class="rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-3 space-y-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-medium">ç»“æœ</div>
        <div class="text-xs text-zinc-500" id="timing"></div>
      </div>
      <div id="summary" class="text-sm text-zinc-700 dark:text-zinc-300">å°šæ— ç»“æœã€‚</div>

      <div class="grid grid-cols-1 gap-3">
        <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 overflow-hidden">
          <div class="px-3 py-2 border-b border-zinc-200 dark:border-zinc-800 text-sm flex items-center justify-between">
            <span>æ•´å½¢åçš„é¢„è§ˆï¼ˆpreviewï¼Œå‰ 10 æ¡ï¼‰</span>
            <button id="downloadPreview" class="text-xs px-2 py-1 rounded border border-zinc-200 dark:border-zinc-800">å¯¼å‡º CSV</button>
          </div>
          <div id="previewBox" class="overflow-x-auto text-sm"></div>
        </div>

        <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 overflow-hidden">
          <div class="px-3 py-2 border-b border-zinc-200 dark:border-zinc-800 text-sm">æœªåŒ¹é…æ˜ç»†ï¼ˆunmatchedï¼Œæœ€å¤š 50 æ¡ï¼‰</div>
          <div id="unmatchedBox" class="overflow-x-auto text-sm"></div>
        </div>

        <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 overflow-hidden">
          <div class="px-3 py-2 border-b border-zinc-200 dark:border-zinc-800 text-sm">é”™è¯¯ï¼ˆæ‹‰å–/æ¸…æ´—ï¼‰</div>
          <div id="errorBox" class="overflow-x-auto text-sm"></div>
        </div>
      </div>
    </section>
  </div>

<script>
const $ = id => document.getElementById(id);
let lastPreview = [];

function loadSettings(){
  $('apiBase').value = localStorage.getItem('ext:api') || '/AppleStockChecker';
  $('token').value   = localStorage.getItem('ext:token') || '';
  $('names').value   = localStorage.getItem('ext:names') || '';
  $('sourcesJson').value = localStorage.getItem('ext:sources') || '';
  const mode = localStorage.getItem('ext:mode') || 'dry';
  document.querySelectorAll('input[name="mode"]').forEach(r => r.checked = (r.value === mode));
}
function saveSettings(){
  localStorage.setItem('ext:api', $('apiBase').value.trim() || '/AppleStockChecker');
  localStorage.setItem('ext:token', $('token').value.trim());
  localStorage.setItem('ext:names', $('names').value.trim());
  localStorage.setItem('ext:sources', $('sourcesJson').value);
  const mode = document.querySelector('input[name="mode"]:checked')?.value || 'dry';
  localStorage.setItem('ext:mode', mode);
}

function setProgress(p){ $('progressBar').style.width = Math.max(0, Math.min(100, p)) + '%'; }
function setStatus(msg){ $('statusMsg').textContent = msg; }
function esc(s){ return (s ?? '').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

function renderTable(rows){
  if (!rows || !rows.length) return '<div class="p-3 text-zinc-500">ï¼ˆæ— ï¼‰</div>';
  const cols = Object.keys(rows[0]);
  let html = '<table class="min-w-full border text-xs"><thead><tr>';
  cols.forEach(c => html += `<th class="p-2 border bg-zinc-100 dark:bg-zinc-900/50">${esc(c)}</th>`);
  html += '</tr></thead><tbody>';
  rows.forEach(r => {
    html += '<tr>';
    cols.forEach(c => html += `<td class="p-2 border">${esc(String(r[c] ?? ''))}</td>`);
    html += '</tr>';
  });
  html += '</tbody></table>';
  return html;
}

function rowsFromPreview(preview){
  // ä»…å±•ç¤ºæœ€æ ¸å¿ƒå­—æ®µï¼Œä¾¿äºäººå·¥éªŒè¯
  return (preview || []).map(x => ({
    shop_name: x.shop_name ?? '',
    part_number: x.part_number ?? '',
    price_new: x.price_new ?? '',
    price_grade_a: x.price_grade_a ?? '',
    price_grade_b: x.price_grade_b ?? '',
    recorded_at: x.recorded_at ?? ''
  }));
}

function rowsFromUnmatched(list){
  return (list || []).map(x => {
    const d = x.data || {};
    return {
      reason: x.reason || '',
      row: typeof x.row === 'number' ? x.row : '',
      shop_name: (d.shop_name ?? d.Shop ?? ''),
      part_number: (d.part_number ?? d.PartNumber ?? ''),
      price_new: d.price_new ?? d.price ?? '',
      recorded_at: d.recorded_at ?? d.time ?? '',
    };
  });
}

function rowsFromErrors(list){
  return (list || []).map(e => ({
    source: (e.source && (e.source.name || e.source.url)) ? `${e.source.name || ''} ${e.source.url || ''}` : '',
    error: e.error || ''
  }));
}

function downloadCSV(rows, filename='preview.csv'){
  if (!rows || !rows.length) return;
  const cols = Object.keys(rows[0]);
  const lines = [];
  lines.push(cols.join(','));
  rows.forEach(r => {
    lines.push(cols.map(c => {
      const v = (r[c] ?? '').toString().replace(/"/g,'""');
      return /[",\n]/.test(v) ? `"${v}"` : v;
    }).join(','));
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

async function runIngest(){
  const apiBase = ($('apiBase').value.trim() || '/AppleStockChecker').replace(/\/$/,'');
  const token = $('token').value.trim();
  const mode = document.querySelector('input[name="mode"]:checked')?.value || 'dry';
  const dryRun = (mode === 'dry');

  if (!token){ setStatus('ç¼ºå°‘ Bearer Token'); return; }

  // ç»„è£…è¯·æ±‚ä½“ï¼šä¼˜å…ˆ sources JSONï¼›å¦åˆ™ names
  let body = {};
  const srcTxt = $('sourcesJson').value.trim();
  if (srcTxt){
    try{
      const obj = JSON.parse(srcTxt);
      if (!obj.sources || !Array.isArray(obj.sources)) { setStatus('sources JSON å¿…é¡»åŒ…å« "sources" æ•°ç»„'); return; }
      body = obj;
    }catch(e){
      setStatus('sources JSON è§£æå¤±è´¥ï¼š' + e.message);
      return;
    }
  }else{
    const names = $('names').value.trim();
    if (names) body.names = names.split(',').map(s => s.trim()).filter(Boolean);
  }

  $('runBtn').disabled = true;
  $('saveBtn').disabled = true;
  $('loading').classList.remove('hidden');
  setProgress(15); setStatus(dryRun ? 'æ¨¡æ‹Ÿæ‰§è¡Œï¼ˆdry_runï¼‰ä¸­â€¦' : 'å®é™…æ‰§è¡Œè½åº“ä¸­â€¦');
  $('summary').textContent = 'å¤„ç†ä¸­â€¦';
  $('previewBox').innerHTML = '';
  $('unmatchedBox').innerHTML = '';
  $('errorBox').innerHTML = '';
  $('timing').textContent = '';
  lastPreview = [];

  const url = `${apiBase}/purchasing-price-records/ingest-external/?dry_run=${dryRun ? 1 : 0}`;
  const t0 = performance.now();

  try{
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    const data = await res.json().catch(()=> ({}));
    $('timing').textContent = `ç”¨æ—¶ ${Math.round(performance.now()-t0)} ms`;
    if (!res.ok){
      $('summary').innerHTML = `<div class="text-red-600">å¤±è´¥ï¼š${esc(data.detail || res.statusText || 'æœªçŸ¥é”™è¯¯')}</div>`;
      setStatus('å¤±è´¥');
      return;
    }

    const rowsTotal = data.rows_total ?? '-';
    const inserted  = data.inserted ?? 0;
    const unmatchedCount = Array.isArray(data.unmatched) ? data.unmatched.length : (data.skipped_no_match ?? 0);
    const errorsCount = Array.isArray(data.errors) ? data.errors.length : 0;

    $('summary').innerHTML = `
      <div>æ•´å½¢æ€»è¡Œï¼š<b>${rowsTotal}</b>ï¼›é¢„è®¡æ–°å¢ï¼š<b class="text-green-600">${inserted}</b>ï¼›æœªåŒ¹é…ï¼š<b class="text-red-600">${unmatchedCount}</b>ï¼›é”™è¯¯ï¼š<b>${errorsCount}</b></div>
      <div class="text-xs text-zinc-500">dry_run=${dryRun}</div>`;

    const pv = rowsFromPreview(data.preview || []);
    $('previewBox').innerHTML = renderTable(pv);
    lastPreview = pv;

    const um = rowsFromUnmatched(data.unmatched || []);
    $('unmatchedBox').innerHTML = renderTable(um);

    const er = rowsFromErrors(data.errors || []);
    $('errorBox').innerHTML = renderTable(er);

    setStatus(dryRun ? 'é¢„è§ˆå®Œæˆï¼ˆæœªå†™åº“ï¼‰' : 'å¯¼å…¥å®Œæˆ');
    setProgress(100);
  }catch(e){
    $('summary').innerHTML = `<div class="text-red-600">è¯·æ±‚å¤±è´¥ï¼š${esc(e.message || e)}</div>`;
    setStatus('å¤±è´¥');
  }finally{
    $('runBtn').disabled = false;
    $('saveBtn').disabled = false;
    $('loading').classList.add('hidden');
  }
}

document.getElementById('runBtn').addEventListener('click', runIngest);
document.getElementById('saveBtn').addEventListener('click', () => { saveSettings(); setStatus('è®¾ç½®å·²ä¿å­˜'); });
document.getElementById('downloadPreview').addEventListener('click', () => downloadCSV(lastPreview, 'preview.csv'));
loadSettings();
</script>
</body>
</html>
