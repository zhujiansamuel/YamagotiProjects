<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSV ä¸Šä¼ ï¼šå››å®¶äºŒæ‰‹åº—æ¸…æ´—å¯¼å…¥ï¼ˆ/import-tradeinï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    (()=>{const pref=localStorage.getItem('theme')||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');if(pref==='dark')document.documentElement.classList.add('dark');window.__toggleTheme=()=>{document.documentElement.classList.toggle('dark');localStorage.setItem('theme',document.documentElement.classList.contains('dark')?'dark':'light');};})();
  </script>
  <style>
    *{scrollbar-width:thin}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}.dark ::-webkit-scrollbar-thumb{background:#334155}
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900 dark:bg-zinc-900 dark:text-zinc-50 min-h-screen">
  <div class="max-w-4xl mx-auto p-4 space-y-4">
    <header class="flex items-center gap-3">
      <h1 class="text-xl font-semibold">CSV ä¸Šä¼ ï¼šå››å®¶äºŒæ‰‹åº—æ¸…æ´—å¯¼å…¥</h1>
      <button class="ml-auto p-2 rounded hover:bg-zinc-100 dark:hover:bg-zinc-800" onclick="__toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
    </header>

    <!-- è®¾ç½®åŒº -->
    <section class="rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-3 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
        <div class="md:col-span-3">
          <label class="block text-sm mb-1">API Baseï¼ˆé»˜è®¤ /apiï¼‰</label>
          <input id="apiBase" type="text" placeholder="/api" class="w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 outline-none" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Bearer Tokenï¼ˆaccessï¼‰</label>
          <input id="token" type="password" placeholder="ç²˜è´´ /api/auth/token/ çš„ access" class="w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 outline-none" />
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end text-sm">
        <label class="inline-flex items-center gap-2"><input id="optCreateShop" type="checkbox" class="w-4 h-4" checked> è‡ªåŠ¨åˆ›å»ºåº—é“º</label>
        <label class="inline-flex items-center gap-2"><input id="optDedupe" type="checkbox" class="w-4 h-4" checked> å»é‡æ›´æ–°</label>
        <label class="inline-flex items-center gap-2"><input id="optDryRun" type="checkbox" class="w-4 h-4"> ä»…æ¸…æ´—ï¼ˆdry runï¼‰</label>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">ç»Ÿä¸€è®°å½•æ—¶é—´ï¼ˆå¯é€‰ï¼ŒISO æˆ–æœ¬åœ°æ—¶é—´ï¼‰</label>
          <input id="recordedAt" type="datetime-local" class="w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 outline-none" />
        </div>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <button id="saveSettings" class="ml-auto px-3 py-1.5 rounded border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800">ä¿å­˜è®¾ç½®</button>
      </div>
    </section>

    <!-- ä¸Šä¼ åŒº -->
    <section class="rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-3 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-start">
        <div class="md:col-span-3">
          <label class="block text-sm mb-1">é€‰æ‹© CSV æ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰</label>
          <input id="fileInput" type="file" accept=".csv,text/csv" multiple class="w-full text-sm" />
          <div id="dropZone" class="mt-2 p-4 border-2 border-dashed rounded-xl text-sm text-zinc-600 dark:text-zinc-400">å¯å°†å¤šä¸ª CSV æ‹–æ‹½åˆ°æ­¤å¤„</div>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">æ ¼å¼è¯´æ˜</label>
          <ul class="text-sm list-disc pl-5 space-y-1 text-zinc-600 dark:text-zinc-400">
            <li>æ”¯æŒå››å®¶ï¼šãƒ¢ãƒã‚¤ãƒ«ãƒŸãƒƒã‚¯ã‚¹ / ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ª / æ£®æ£®è²·å– / è²·å–ãƒ«ãƒ‡ãƒ¤ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰</li>
            <li>å­—æ®µä¼šæ¸…æ´—æˆç»Ÿä¸€ç»“æ„å¹¶æŒ‰ <b>PNÃ—é—¨åº—</b> èšåˆä¸ºä¸€æ¡è®°å½•ï¼ˆæ–°å“/A/Bï¼‰</li>
            <li>æ— æ³•è¯†åˆ« PN çš„è¡Œä¼šè·³è¿‡ï¼›å¯é€‰ç»Ÿä¸€ <code>recorded_at</code></li>
          </ul>
        </div>
      </div>

      <div class="space-y-2">
        <div class="h-2 bg-zinc-200 dark:bg-zinc-800 rounded overflow-hidden"><div id="progressBar" class="h-full bg-black dark:bg-white w-0"></div></div>
        <div class="flex items-center gap-2 text-sm"><span id="statusMsg" class="text-zinc-600 dark:text-zinc-400">ç­‰å¾…ä¸Šä¼ â€¦</span><span id="loading" class="hidden text-zinc-500">ï¼ˆä¸Šä¼ ä¸­â€¦ï¼‰</span></div>
        <div class="flex items-center gap-2">
          <button id="uploadBtn" class="px-4 py-2 rounded-lg bg-black text-white dark:bg-white dark:text-black">ä¸Šä¼ </button>
          <button id="cancelBtn" class="px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800" disabled>å–æ¶ˆ</button>
        </div>
      </div>
    </section>

    <!-- ç»“æœåŒº -->
    <section class="rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-3 space-y-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-medium">å¯¼å…¥ç»“æœï¼ˆ/purchasing-price-records/import-tradein/ï¼‰</div>
        <div class="text-xs text-zinc-500" id="timing"></div>
      </div>
      <div id="summary" class="text-sm text-zinc-700 dark:text-zinc-300">å°šæ— ç»“æœã€‚</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <div class="text-xs opacity-70 mb-1">é¢„è§ˆï¼ˆå‰ 10 æ¡ï¼‰</div>
          <div id="previewBox" class="overflow-x-auto text-sm"></div>
        </div>
        <div>
          <div class="text-xs opacity-70 mb-1">é”™è¯¯</div>
          <div id="errorBox" class="overflow-x-auto text-sm"></div>
        </div>
      </div>
    </section>
  </div>

<script>
const $ = id => document.getElementById(id);
let xhr = null;

function loadSettings(){
  $('apiBase').value = localStorage.getItem('tradein:apiBase') || '/AppleStockChecker';
  $('token').value = localStorage.getItem('tradein:token') || '';
  $('optCreateShop').checked = JSON.parse(localStorage.getItem('tradein:createShop') || 'true');
  $('optDedupe').checked = JSON.parse(localStorage.getItem('tradein:dedupe') || 'true');
  $('optDryRun').checked = JSON.parse(localStorage.getItem('tradein:dryRun') || 'false');
  const ra = localStorage.getItem('tradein:recordedAt') || '';
  if (ra) $('recordedAt').value = ra;
}
function saveSettings(){
  localStorage.setItem('tradein:apiBase', $('apiBase').value.trim() || '/AppleStockChecker');
  localStorage.setItem('tradein:token', $('token').value.trim());
  localStorage.setItem('tradein:createShop', JSON.stringify($('optCreateShop').checked));
  localStorage.setItem('tradein:dedupe', JSON.stringify($('optDedupe').checked));
  localStorage.setItem('tradein:dryRun', JSON.stringify($('optDryRun').checked));
  localStorage.setItem('tradein:recordedAt', $('recordedAt').value);
}

function setProgress(p){ $('progressBar').style.width = Math.max(0, Math.min(100, p)) + '%'; }
function setStatus(msg){ $('statusMsg').textContent = msg; }
function esc(s){ return (s??'').toString().replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

function renderTable(rows){
  if(!rows || !rows.length) return '<div class="text-zinc-500">ï¼ˆæ— ï¼‰</div>';
  const cols = Object.keys(rows[0]);
  let html = '<table class="min-w-full border text-xs"><thead><tr>'; cols.forEach(c=> html += `<th class=\"p-2 border bg-zinc-100 dark:bg-zinc-900/50\">${esc(c)}</th>`); html += '</tr></thead><tbody>';
  rows.forEach(r=>{ html += '<tr>'; cols.forEach(c=> html += `<td class=\"p-2 border\">${esc(r[c])}</td>`); html += '</tr>'; });
  html += '</tbody></table>';
  return html;
}

function upload(){
  const apiBase = ($('apiBase').value.trim() || '/AppleStockChecker').replace(/\/$/, '');
  const token = $('token').value.trim();
  const files = $('fileInput').files;
  if(!files || !files.length){ setStatus('è¯·å…ˆé€‰æ‹© 1 ä¸ªæˆ–å¤šä¸ª CSV æ–‡ä»¶'); return; }
  if(!token){ setStatus('ç¼ºå°‘ Bearer Tokenï¼ˆè¯·ä» /AppleStockChecker/auth/token/ è·å– accessï¼‰'); return; }

  const url = `${apiBase}/purchasing-price-records/import-tradein/`;
  const fd = new FormData();
  for (const f of files) fd.append('files', f, f.name);
  fd.append('create_shop', $('optCreateShop').checked ? '1' : '0');
  fd.append('dedupe', $('optDedupe').checked ? '1' : '0');
  fd.append('dry_run', $('optDryRun').checked ? '1' : '0');
  const ra = $('recordedAt').value;
  const qs = new URLSearchParams();
  if (ra) qs.set('recorded_at', new Date(ra).toISOString());

  $('uploadBtn').disabled = true;
  $('cancelBtn').disabled = false;
  $('loading').classList.remove('hidden');
  setProgress(0); setStatus('å¼€å§‹ä¸Šä¼ â€¦');
  $('summary').textContent = 'å¤„ç†ä¸­â€¦';
  $('previewBox').innerHTML = '';
  $('errorBox').innerHTML = '';
  $('timing').textContent = '';

  xhr = new XMLHttpRequest();
  xhr.open('POST', url + (qs.toString() ? ('?' + qs.toString()) : ''));
  xhr.setRequestHeader('Authorization', `Bearer ${token}`);

  const t0 = performance.now();
  xhr.upload.onprogress = (e)=>{ if(e.lengthComputable){ setProgress(e.loaded * 100 / e.total); } };
  xhr.onreadystatechange = () => {
    if(xhr.readyState === 4){
      $('uploadBtn').disabled = false;
      $('cancelBtn').disabled = true;
      $('loading').classList.add('hidden');
      setProgress(100);
      const ms = Math.round(performance.now() - t0);
      $('timing').textContent = `ç”¨æ—¶ ${ms} ms`;

      let res = {};
      try{ res = JSON.parse(xhr.responseText || '{}'); }catch(err){ res = { detail:`è§£æå“åº”å¤±è´¥ï¼š${err.message||err}` }; }

      if(xhr.status >= 200 && xhr.status < 300){
        $('summary').innerHTML = `
          <div>æ¸…æ´—åˆå¹¶è¡Œæ•°ï¼š<b>${res.rows_total ?? '-'}</b>ï¼ŒæŒ‰ <b>PNÃ—åº—é“º</b> èšåˆï¼š<b>${res.grouped ?? '-'}</b></div>
          <div>æ–°å¢ï¼š<b class="text-green-600">${res.inserted ?? 0}</b>ï¼Œæ›´æ–°ï¼š<b>${res.updated ?? 0}</b>ï¼Œå› ç¼º PN è·³è¿‡ï¼š<b>${res.skipped_no_pn ?? 0}</b></div>
          <div class="text-xs text-zinc-500">é€‰é¡¹ï¼šcreate_shop=${res.options?.create_shop}, dedupe=${res.options?.dedupe}, dry_run=${res.options?.dry_run}</div>`;
        $('previewBox').innerHTML = renderTable(res.preview || []);
        const errRows = (res.errors || []).map(e=>({ file:e.file, error:e.error }));
        $('errorBox').innerHTML = renderTable(errRows);
        setStatus('å®Œæˆ');
      } else {
        $('summary').innerHTML = `<div class="text-red-600">å¤±è´¥ï¼š${esc(res.detail || xhr.statusText || 'æœªçŸ¥é”™è¯¯')}</div>`;
        setStatus('å¤±è´¥');
      }
    }
  };
  xhr.onerror = ()=>{ $('summary').innerHTML = '<div class="text-red-600">ç½‘ç»œé”™è¯¯</div>'; setStatus('å¤±è´¥'); };
  xhr.onabort = ()=>{ $('summary').innerHTML = '<div class="text-zinc-600">å·²å–æ¶ˆ</div>'; setStatus('å·²å–æ¶ˆ'); setProgress(0); };

  xhr.send(fd);
}

function cancelUpload(){ if(xhr){ xhr.abort(); } }

// æ‹–æ‹½
(function setupDrag(){
  const dz = $('dropZone');
  const fi = $('fileInput');
  ['dragenter','dragover'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); dz.classList.add('ring-2','ring-black','dark:ring-white'); }));
  ['dragleave','drop'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); dz.classList.remove('ring-2','ring-black','dark:ring-white'); }));
  dz.addEventListener('drop', (e)=>{ const files = e.dataTransfer.files; if(files && files.length){ fi.files = files; $('statusMsg').textContent = `å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶`; } });
})();

// äº‹ä»¶ç»‘å®šä¸åˆå§‹åŒ–
$('uploadBtn').addEventListener('click', upload);
$('cancelBtn').addEventListener('click', cancelUpload);
$('saveSettings').addEventListener('click', ()=>{ saveSettings(); $('statusMsg').textContent='è®¾ç½®å·²ä¿å­˜'; });
$('fileInput').addEventListener('change', ()=>{ const fs=$('fileInput').files; if(fs && fs.length){ $('statusMsg').textContent = `å·²é€‰æ‹© ${fs.length} ä¸ªæ–‡ä»¶`; }});

loadSettings();
</script>
</body>
</html>
