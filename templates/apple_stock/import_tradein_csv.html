<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Excel ä¸Šä¼  & é¢„è§ˆï¼ˆå››å®¶äºŒæ‰‹åº—æ¸…æ´—å¯¼å…¥ /import-tradeinï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    (()=>{const pref=localStorage.getItem('theme')||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');if(pref==='dark')document.documentElement.classList.add('dark');window.__toggleTheme=()=>{document.documentElement.classList.toggle('dark');localStorage.setItem('theme',document.documentElement.classList.contains('dark')?'dark':'light');};})();
  </script>
  <style>
    *{scrollbar-width:thin}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}.dark ::-webkit-scrollbar-thumb{background:#334155}
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900 dark:bg-zinc-900 dark:text-zinc-50 min-h-screen">
  <div class="max-w-5xl mx-auto p-4 space-y-4">
    <header class="flex items-center gap-3">
      <h1 class="text-xl font-semibold">Excel ä¸Šä¼  & é¢„è§ˆï¼šå››å®¶äºŒæ‰‹åº—æ¸…æ´—å¯¼å…¥</h1>
      <button class="ml-auto p-2 rounded hover:bg-zinc-100 dark:hover:bg-zinc-800" onclick="__toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
    </header>

    <!-- è®¾ç½®åŒº -->
    <section class="rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-3 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
        <div class="md:col-span-3">
          <label class="block text-sm mb-1">API Baseï¼ˆé»˜è®¤ /apiï¼‰</label>
          <input id="apiBase" type="text" placeholder="/api" class="w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 outline-none" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Bearer Tokenï¼ˆaccessï¼‰</label>
          <input id="token" type="password" placeholder="ç²˜è´´ /api/auth/token/ çš„ access" class="w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 outline-none" />
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end text-sm">
        <label class="inline-flex items-center gap-2"><input id="optCreateShop" type="checkbox" class="w-4 h-4" checked> è‡ªåŠ¨åˆ›å»ºåº—é“º</label>
        <!-- è¯´æ˜ï¼šé¢„è§ˆæ¨¡å¼ä¼šå¼ºåˆ¶ dry_run=1ï¼Œè¿™é‡Œçš„å‹¾é€‰åªå½±å“â€œæ‰§è¡Œå¯¼å…¥â€ -->
        <label class="inline-flex items-center gap-2"><input id="optDryRun" type="checkbox" class="w-4 h-4"> ï¼ˆå¯¼å…¥æ—¶ï¼‰ä»…æ¸…æ´—</label>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">ç»Ÿä¸€è®°å½•æ—¶é—´ï¼ˆå¯é€‰ï¼ŒISO æˆ–æœ¬åœ°æ—¶é—´ï¼‰</label>
          <input id="recordedAt" type="datetime-local" class="w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 outline-none" />
        </div>
        <div class="md:col-span-1 flex items-center justify-end gap-2">
          <button id="saveSettings" class="px-3 py-1.5 rounded border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800">ä¿å­˜è®¾ç½®</button>
        </div>
      </div>
    </section>

    <!-- ä¸Šä¼ åŒº -->
    <section class="rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-3 space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-start">
        <div class="md:col-span-3">
          <label class="block text-sm mb-1">é€‰æ‹© Excel æ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰</label>
          <!-- ä»…é™ Excelï¼šxlsx/xls/xlsm/ods åŠå¸¸è§ MIME -->
          <input id="fileInput" type="file"
                 accept=".xlsx,.xls,.xlsm,.ods,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,application/vnd.ms-excel.sheet.macroEnabled.12,application/vnd.oasis.opendocument.spreadsheet"
                 multiple class="w-full text-sm" />
          <div id="dropZone" class="mt-2 p-4 border-2 border-dashed rounded-xl text-sm text-zinc-600 dark:text-zinc-400">
            å¯å°†å¤šä¸ª Excel æ–‡ä»¶æ‹–æ‹½åˆ°æ­¤å¤„ï¼ˆæ”¯æŒï¼š.xlsx / .xls / .xlsm / .odsï¼‰
          </div>
          <p class="text-xs text-zinc-500 mt-2">
            æ”¯æŒå››å®¶ï¼šãƒ¢ãƒã‚¤ãƒ«ãƒŸãƒƒã‚¯ã‚¹ / ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ª / æ£®æ£®è²·å– / è²·å–ãƒ«ãƒ‡ãƒ¤ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰ã€‚<br>
            <b>é¢„è§ˆæ¨¡å¼ä¸ä¼šå†™åº“</b>ï¼Œä»…å±•ç¤ºæ¸…æ´—ä¸èšåˆç»“æœï¼ˆæ–°å“é›†åˆå–æœ€å¤§ï¼Œå…¶ä»–é›†åˆæŒ‰é™åºå‰ä¸¤æ¡£å†™å…¥ A/Bï¼‰ã€‚
          </p>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">æ¥å£è¯´æ˜</label>
          <ul class="text-sm list-disc pl-5 space-y-1 text-zinc-600 dark:text-zinc-400">
            <li>é¢„è§ˆï¼š<code>POST /api/purchasing-price-records/import-tradein/?dry_run=1</code>ï¼ˆä»…æ¸…æ´—ï¼Œä¸å†™åº“ï¼›ç°åœ¨åªæ¥å— Excelï¼‰</li>
            <li>å¯¼å…¥ï¼š<code>POST /api/purchasing-price-records/import-tradein/</code></li>
            <li>é¢œè‰²ç¼ºå¤±/â€œå…¨è‰²â€ â†’ åŒå‹å·+å®¹é‡çš„æ‰€æœ‰é¢œè‰²åŒä»·</li>
          </ul>
        </div>
      </div>

      <div class="space-y-2">
        <div class="h-2 bg-zinc-200 dark:bg-zinc-800 rounded overflow-hidden"><div id="progressBar" class="h-full bg-black dark:bg-white w-0"></div></div>
        <div class="flex items-center gap-2 text-sm"><span id="statusMsg" class="text-zinc-600 dark:text-zinc-400">ç­‰å¾…ä¸Šä¼ â€¦</span><span id="loading" class="hidden text-zinc-500">ï¼ˆè¿›è¡Œä¸­â€¦ï¼‰</span></div>
        <div class="flex flex-wrap items-center gap-2">
          <button id="previewBtn" class="px-4 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 hover:bg-zinc-100 dark:hover:bg-zinc-800">ä»…é¢„è§ˆï¼ˆä¸å†™åº“ï¼‰</button>
          <button id="uploadBtn"  class="px-4 py-2 rounded-lg bg-black text-white dark:bg-white dark:text-black">æ‰§è¡Œå¯¼å…¥ï¼ˆå†™åº“ï¼‰</button>
          <button id="cancelBtn"  class="px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800" disabled>å–æ¶ˆ</button>
        </div>
      </div>
    </section>

    <!-- ç»“æœåŒº -->
    <section class="rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-3 space-y-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-medium">ç»“æœ</div>
        <div class="text-xs text-zinc-500" id="timing"></div>
      </div>
      <div id="summary" class="text-sm text-zinc-700 dark:text-zinc-300">å°šæ— ç»“æœã€‚</div>

      <div class="grid grid-cols-1 gap-3">
        <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 overflow-hidden">
          <div class="px-3 py-2 border-b border-zinc-200 dark:border-zinc-800 text-sm">æ¸…æ´—/èšåˆé¢„è§ˆï¼ˆå‰ 10 æ¡ï¼Œä¸å†™åº“ï¼‰</div>
          <div id="previewBox" class="overflow-x-auto text-sm"></div>
        </div>

        <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 overflow-hidden">
          <div class="px-3 py-2 border-b border-zinc-200 dark:border-zinc-800 text-sm">æœªåŒ¹é…æ˜ç»†ï¼ˆä»…åœ¨åç«¯è¿”å›æ—¶æ˜¾ç¤ºï¼‰</div>
          <div id="unmatchedBox" class="overflow-x-auto text-sm text-zinc-500 p-3">åç«¯æœªè¿”å›æœªåŒ¹é…æ˜ç»†ï¼ˆä»…æä¾›æ•°é‡ï¼‰ã€‚</div>
        </div>

        <div class="rounded-xl border border-zinc-200 dark:border-zinc-800 overflow-hidden">
          <div class="px-3 py-2 border-b border-zinc-200 dark:border-zinc-800 text-sm">é”™è¯¯</div>
          <div id="errorBox" class="overflow-x-auto text-sm"></div>
        </div>
      </div>
    </section>
  </div>

<script>
const $ = id => document.getElementById(id);
let xhr = null;

function loadSettings(){
  $('apiBase').value = localStorage.getItem('tradein:apiBase') || '/AppleStockChecker';
  $('token').value = localStorage.getItem('tradein:token') || '';
  $('optCreateShop').checked = JSON.parse(localStorage.getItem('tradein:createShop') || 'true');
  $('optDryRun').checked = JSON.parse(localStorage.getItem('tradein:dryRun') || 'false');
  const ra = localStorage.getItem('tradein:recordedAt') || '';
  if (ra) $('recordedAt').value = ra;
}
function saveSettings(){
  localStorage.setItem('tradein:apiBase', $('apiBase').value.trim() || '/AppleStockChecker');
  localStorage.setItem('tradein:token', $('token').value.trim());
  localStorage.setItem('tradein:createShop', JSON.stringify($('optCreateShop').checked));
  localStorage.setItem('tradein:dryRun', JSON.stringify($('optDryRun').checked));
  localStorage.setItem('tradein:recordedAt', $('recordedAt').value);
}
function setProgress(p){ $('progressBar').style.width = Math.max(0, Math.min(100, p)) + '%'; }
function setStatus(msg){ $('statusMsg').textContent = msg; }
function esc(s){ return (s??'').toString().replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

function renderTable(rows){
  if(!rows || !rows.length) return '<div class="text-zinc-500 p-3">ï¼ˆæ— ï¼‰</div>';
  const cols = Object.keys(rows[0]);
  let html = '<table class="min-w-full border text-xs"><thead><tr>';
  cols.forEach(c=> html += `<th class="p-2 border bg-zinc-100 dark:bg-zinc-900/50">${esc(c)}</th>`);
  html += '</tr></thead><tbody>';
  rows.forEach(r=>{ html += '<tr>'; cols.forEach(c=> html += `<td class="p-2 border">${esc(String(r[c] ?? ''))}</td>`); html += '</tr>'; });
  html += '</tbody></table>';
  return html;
}

function buildFormData(){
  const files = $('fileInput').files;
  const fd = new FormData();
  for (const f of files) fd.append('files', f, f.name);
  fd.append('create_shop', $('optCreateShop').checked ? '1' : '0');
  return fd;
}
function buildQuery({dryRunForced=false}={}){
  const qs = new URLSearchParams();
  const ra = $('recordedAt').value;
  if (ra) qs.set('recorded_at', new Date(ra).toISOString());
  if (dryRunForced) qs.set('dry_run', '1');
  else if ($('optDryRun').checked) qs.set('dry_run','1');
  return qs.toString();
}

function pickUnmatched(res){
  return res.unmatched || res.unmatched_preview || res.unmatched_records || res.unmatched_buckets || [];
}

function toRowsForPreview(res){
  return (res.preview || []).map(x => ({
    shop_name: x.shop_name ?? x.key?.split('||')[1] ?? '',
    part_number: x.pn || x.part_number || x.meta?.pn || '',
    jan: x.jan || x.meta?.jan || '',
    model_name: x.model_name || x.model || x.meta?.model_name || '',
    capacity_gb: x.capacity_gb ?? x.meta?.capacity_gb ?? '',
    color_raw: x.color ?? x.color_raw ?? x.meta?.color_raw ?? '',
    color_canon: x.color_canon ?? x.meta?.color_canon ?? '',
    color_any: String(x.color_any ?? x.meta?.color_any ?? false),
    price_new: x.price_new ?? '',
    price_grade_a: x.price_grade_a ?? '',
    price_grade_b: x.price_grade_b ?? '',
    recorded_at: res.options?.recorded_at || ''
  }));
}

function toRowsForUnmatched(list){
  return list.map(x => ({
    shop_name: x.shop_name ?? x.key?.split('||')[1] ?? '',
    part_number: x.pn || x.part_number || x.meta?.pn || '',
    jan: x.jan || x.meta?.jan || '',
    model_name: x.model_name || x.model || x.meta?.model_name || '',
    capacity_gb: x.capacity_gb ?? x.meta?.capacity_gb ?? '',
    color_raw: x.color ?? x.color_raw ?? x.meta?.color_raw ?? '',
    color_canon: x.color_canon ?? x.meta?.color_canon ?? '',
    color_any: String(x.color_any ?? x.meta?.color_any ?? false),
    price_new: x.price_new ?? x.meta?.price_new ?? '',
    price_grade_a: x.price_grade_a ?? x.meta?.price_grade_a ?? '',
    price_grade_b: x.price_grade_b ?? x.meta?.price_grade_b ?? '',
    reason: x.reason || x.error || x.note || ''
  }));
}

function send({previewOnly=false}){
  const apiBase = ($('apiBase').value.trim() || '/AppleStockChecker').replace(/\/$/,'');
  const token = $('token').value.trim();
  const files = $('fileInput').files;
  if(!files || !files.length){ setStatus('è¯·å…ˆé€‰æ‹© 1 ä¸ªæˆ–å¤šä¸ª Excel æ–‡ä»¶'); return; }
  if(!token){ setStatus('ç¼ºå°‘ Bearer Tokenï¼ˆè¯·ä» /AppleStockChecker/auth/token/ è·å– accessï¼‰'); return; }

  const url = `${apiBase}/purchasing-price-records/import-tradein/` + (buildQuery({dryRunForced:previewOnly}) ? ('?'+buildQuery({dryRunForced:previewOnly})) : '');
  const fd = buildFormData();

  $('uploadBtn').disabled = true;
  $('previewBtn').disabled = true;
  $('cancelBtn').disabled = false;
  $('loading').classList.remove('hidden');
  setProgress(0); setStatus(previewOnly ? 'é¢„è§ˆä¸­â€¦ï¼ˆä¸å†™åº“ï¼‰' : 'å¯¼å…¥ä¸­â€¦');
  $('summary').textContent = 'å¤„ç†ä¸­â€¦';
  $('previewBox').innerHTML = '';
  $('unmatchedBox').innerHTML = 'åç«¯æœªè¿”å›æœªåŒ¹é…æ˜ç»†ï¼ˆä»…æä¾›æ•°é‡ï¼‰ã€‚';
  $('errorBox').innerHTML = '';
  $('timing').textContent = '';

  xhr = new XMLHttpRequest();
  xhr.open('POST', url);
  xhr.setRequestHeader('Authorization', `Bearer ${token}`);

  const t0 = performance.now();
  xhr.upload.onprogress = (e)=>{ if(e.lengthComputable){ setProgress(e.loaded * 100 / e.total); } };
  xhr.onreadystatechange = () => {
    if(xhr.readyState === 4){
      $('uploadBtn').disabled = false;
      $('previewBtn').disabled = false;
      $('cancelBtn').disabled = true;
      $('loading').classList.add('hidden');
      setProgress(100);
      $('timing').textContent = `ç”¨æ—¶ ${Math.round(performance.now()-t0)} ms`;

      let res={};
      try{ res = JSON.parse(xhr.responseText || '{}'); }catch(err){ res = { detail:`è§£æå“åº”å¤±è´¥ï¼š${err.message||err}` }; }

      if(xhr.status >= 200 && xhr.status < 300){
        const aggregated = res.aggregated ?? res.grouped ?? '-';
        const inserted   = res.inserted ?? 0;
        const skipped    = res.skipped_no_match ?? res.skipped ?? 0;
        const rowsTotal  = res.rows_total ?? '-';
        $('summary').innerHTML = `
          <div>æ¸…æ´—åˆå¹¶è¡Œæ•°ï¼š<b>${rowsTotal}</b>ï¼›èšåˆæ¡¶ï¼š<b>${aggregated}</b>${previewOnly? 'ï¼›<span class="ml-2">ï¼ˆé¢„è§ˆæ¨¡å¼ï¼Œä¸å†™åº“ï¼‰</span>':''}</div>
          <div>é¢„è®¡æ–°å¢æ¡æ•°ï¼š<b class="text-green-600">${inserted}</b>ï¼›æœªåŒ¹é…åˆ° iPhoneï¼š<b class="text-red-600">${skipped}</b></div>
          <div class="text-xs text-zinc-500">recorded_at=${esc(res.options?.recorded_at || '')}ï¼Œcreate_shop=${res.options?.create_shop ?? $('optCreateShop').checked}ï¼Œdry_run=${previewOnly ? true : !!res.options?.dry_run}</div>
        `;

        $('previewBox').innerHTML = renderTable(toRowsForPreview(res));

        const unmatchedArr = pickUnmatched(res);
        if (Array.isArray(unmatchedArr) && unmatchedArr.length){
          $('unmatchedBox').innerHTML = renderTable(toRowsForUnmatched(unmatchedArr));
        } else {
          $('unmatchedBox').innerHTML = '<div class="text-zinc-500 p-3">åç«¯æœªè¿”å›æœªåŒ¹é…æ˜ç»†ï¼ˆä»…æä¾›æ•°é‡ï¼‰ã€‚å¦‚éœ€æ˜ç»†ï¼Œè¯·åœ¨åç«¯ dry_run=1 æ—¶è¿”å› unmatched åˆ—è¡¨ã€‚</div>';
        }

        const errRows = (res.errors || []).map(e=>({ file: e.file, error: e.error || e.detail || '' }));
        $('errorBox').innerHTML = renderTable(errRows);

        setStatus(previewOnly ? 'é¢„è§ˆå®Œæˆï¼ˆæœªå†™åº“ï¼‰' : 'å¯¼å…¥å®Œæˆ');
      } else {
        $('summary').innerHTML = `<div class="text-red-600">å¤±è´¥ï¼š${esc(res.detail || xhr.statusText || 'æœªçŸ¥é”™è¯¯')}</div>`;
        setStatus('å¤±è´¥');
      }
    }
  };
  xhr.onerror = ()=>{ $('summary').innerHTML = '<div class="text-red-600">ç½‘ç»œé”™è¯¯</div>'; setStatus('å¤±è´¥'); };
  xhr.onabort = ()=>{ $('summary').innerHTML = '<div class="text-zinc-600">å·²å–æ¶ˆ</div>'; setStatus('å·²å–æ¶ˆ'); setProgress(0); };

  xhr.send(fd);
}

function cancelUpload(){ if(xhr){ xhr.abort(); } }

// æ‹–æ‹½
(function setupDrag(){
  const dz = $('dropZone');
  const fi = $('fileInput');
  ['dragenter','dragover'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); dz.classList.add('ring-2','ring-black','dark:ring-white'); }));
  ['dragleave','drop'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); dz.classList.remove('ring-2','ring-black','dark:ring-white'); }));
  dz.addEventListener('drop', (e)=>{ const files = e.dataTransfer.files; if(files && files.length){ fi.files = files; $('statusMsg').textContent = `å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶`; } });
})();

// äº‹ä»¶ç»‘å®šä¸åˆå§‹åŒ–
$('saveSettings').addEventListener('click', ()=>{ saveSettings(); $('statusMsg').textContent='è®¾ç½®å·²ä¿å­˜'; });
$('fileInput').addEventListener('change', ()=>{ const fs=$('fileInput').files; if(fs && fs.length){ $('statusMsg').textContent = `å·²é€‰æ‹© ${fs.length} ä¸ªæ–‡ä»¶`; }});
$('uploadBtn').addEventListener('click', ()=> send({previewOnly:false}));
$('previewBtn').addEventListener('click', ()=> send({previewOnly:true}));
$('cancelBtn').addEventListener('click', cancelUpload);
loadSettings();
</script>
</body>
</html>
