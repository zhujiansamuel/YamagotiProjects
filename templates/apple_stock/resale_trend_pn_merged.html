<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>二手店回收价历史（按 PN → 各店）</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <!-- Chart.js & 时间轴适配器（date-fns） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <!-- 缩放/平移插件（只用按钮触发） -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>

  <style>
    *{scrollbar-width:thin}
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900 min-h-screen">
  <div class="max-w-7xl mx-auto p-4 space-y-4">
    <header class="flex items-center gap-3">
      <h1 class="text-xl font-semibold">二手店回收价历史（按 PN → 各店）</h1>
    </header>

    <!-- 查询栏 -->
    <section class="rounded-2xl border border-zinc-200 bg-white p-3">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">PN（唯一编码）</label>
          <input id="pnInput" list="pnOptions" type="text" placeholder="如：MTUW3J/A"
                 class="w-full px-3 py-2 rounded-lg border border-zinc-200 outline-none bg-white"/>
          <datalist id="pnOptions"></datalist>
          <p class="text-xs text-zinc-500 mt-1">从下拉建议选择，或输入完整 PN。</p>
        </div>
        <div>
          <label class="block text-sm mb-1">最近 N 天</label>
          <input id="daysInput" type="number" min="1" max="180" value="30"
                 class="w-full px-3 py-2 rounded-lg border border-zinc-200 outline-none bg-white"/>
        </div>
        <div class="flex items-center gap-2">
          <input id="showPoints" type="checkbox" class="w-4 h-4" checked>
          <label for="showPoints" class="text-sm">显示点</label>
        </div>
        <div class="flex items-center gap-2 md:justify-end">
          <button id="refreshBtn" class="px-3 py-2 bg-black text-white rounded-lg">查询</button>
          <span id="loading" class="text-sm text-zinc-600 hidden">加载中…</span>
        </div>
      </div>

      <!-- 平均线门店选择 -->
      <div class="mt-3">
        <label class="text-sm font-medium">平均线参与门店：</label>
        <div class="text-xs text-zinc-500">按 30 分钟分桶；勾选后点击“刷新”或“重算平均”更新平均线。</div>
        <div id="shopChecks" class="flex flex-wrap gap-3 mt-2"></div>
        <div class="flex items-center gap-2 mt-2">
          <input id="toggleAvg" type="checkbox" class="w-4 h-4" checked>
          <label for="toggleAvg" class="text-sm">显示平均线</label>
          <button id="recalcAvgBtn" class="px-2 py-1 border rounded">重算平均</button>
          <span id="avgHint" class="text-xs text-zinc-500"></span>
        </div>
      </div>

      <div id="pnMeta" class="text-sm text-zinc-600 mt-3"></div>
      <p class="text-xs text-zinc-500 mt-2">
        说明：不再使用滚轮缩放。请使用下方“平移/缩放/重置”按钮。平均线为“每 30 分钟分桶”的算术平均（忽略空值）。
      </p>
    </section>

    <!-- 控制条（按钮缩放/平移） -->
    <section class="rounded-2xl border border-zinc-200 bg-white p-3">
      <div class="flex flex-wrap gap-2 items-center">
        <span class="text-sm text-zinc-600 mr-2">视图控制：</span>
        <button id="panLeftBtn"  class="px-3 py-1.5 border rounded">← 平移</button>
        <button id="zoomInBtn"   class="px-3 py-1.5 border rounded">放大</button>
        <button id="zoomOutBtn"  class="px-3 py-1.5 border rounded">缩小</button>
        <button id="panRightBtn" class="px-3 py-1.5 border rounded">平移 →</button>
        <button id="resetZoomBtn" class="px-3 py-1.5 border rounded">重置缩放</button>
        <span class="text-xs text-zinc-500 ml-2">（作用于下方三张图）</span>
      </div>
    </section>

    <!-- 三个图表 -->
    <section class="space-y-6">
      <div class="rounded-2xl border border-zinc-200 bg-white">
        <div class="px-3 py-2 border-b border-zinc-200 text-sm">新品价格</div>
        <div class="p-3"><canvas id="chart-new"></canvas></div>
      </div>
      <div class="rounded-2xl border border-zinc-200 bg-white">
        <div class="px-3 py-2 border-b border-zinc-200 text-sm">A 品价格</div>
        <div class="p-3"><canvas id="chart-a"></canvas></div>
      </div>
      <div class="rounded-2xl border border-zinc-200 bg-white">
        <div class="px-3 py-2 border-b border-zinc-200 text-sm">B 品价格</div>
        <div class="p-3"><canvas id="chart-b"></canvas></div>
      </div>
    </section>

    <footer class="text-xs text-zinc-500">数据来源：/AppleStockChecker/purchasing-price-records 与 /AppleStockChecker/iphones/（需登录）</footer>
  </div>
    <script>
  // v4 + UMD 的写法
  Chart.register(window['chartjs-plugin-zoom']);
</script>
<script>
const apiBase = '/AppleStockChecker';
const $ = sel => document.querySelector(sel);
let charts = { new: null, a: null, b: null };

// —— Session 认证：带 Cookie，未登录自动跳转 —— //
function handleAuth(resp) {
  if (resp.status === 401 || resp.status === 403) {
    const next = encodeURIComponent(location.pathname + location.search);
    location.href = `/accounts/login/?next=${next}`;
    return false;
  }
  if (resp.redirected && resp.url.includes('/accounts/login')) {
    const next = encodeURIComponent(location.pathname + location.search);
    location.href = `/accounts/login/?next=${next}`;
    return false;
  }
  return true;
}
const FETCH_INIT = { credentials: 'same-origin' };

// —— 工具 —— //
function esc(s){return (s??'').toString().replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));}
function toISODate(d){ return new Date(d).toISOString(); }
function normalizeNext(url){ return url ? new URL(url, location.origin).toString() : null; }

// —— 30 分钟分桶：将 ts 对齐到本地时区的半小时边界 —— //
function slot30Key(ts){
  const d = new Date(ts);
  d.setSeconds(0,0);
  const mins = d.getHours()*60 + d.getMinutes();
  const slot = Math.floor(mins / 30) * 30;
  d.setHours(Math.floor(slot/60), slot%60, 0, 0);
  return d.getTime(); // 返回该 30min 槽的起始时间戳
}

// 统一分页拉取
async function fetchAll(url, maxPages=80){
  const out=[]; let next=url, page=0;
  while(next && page<maxPages){
    const r=await fetch(next, FETCH_INIT);
    if(!handleAuth(r)) throw "未登录";
    if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    const j=await r.json(); page++;
    if(Array.isArray(j)) return j;
    out.push(...(j.results||[]));
    next = normalizeNext(j.next);
  }
  return out;
}

// PN 建议
async function loadPnOptions(){
  try{
    const rows = await fetchAll(`${apiBase}/iphones/?ordering=model_name`);
    const html = rows.map(x => {
      const cap = (x.capacity_gb % 1024 === 0) ? (x.capacity_gb/1024 + 'TB') : (x.capacity_gb + 'GB');
      return `<option value="${esc(x.part_number)}">${esc(x.model_name)} ${esc(cap)} ${esc(x.color)}</option>`;
    }).join('');
    $('#pnOptions').innerHTML = html;
  }catch(e){ if(e==="未登录") return; }
}

// —— 平均线（按 30 分钟分桶，跨店算术平均；忽略空值） —— //
function calcAvgSlot30(datasets, selectedLabels){
  const acc = new Map();  // slotKey -> {sum, n}
  for(const ds of datasets){
    if (!selectedLabels.has(ds.label)) continue;
    for(const p of ds.data||[]){
      if (p==null || p.y==null || Number.isNaN(p.y)) continue;
      const k = slot30Key(p.x);
      const cur = acc.get(k) || {sum:0, n:0};
      cur.sum += Number(p.y);
      cur.n += 1;
      acc.set(k, cur);
    }
  }
  return Array.from(acc.entries())
    .sort((a,b)=>a[0]-b[0])
    .map(([k,v]) => ({ x:Number(k), y: v.n ? v.sum/v.n : null }));
}

// 门店复选
function renderShopChecks(allLabels){
  const host = $('#shopChecks'); host.innerHTML='';
  const allId='shop_all';
  host.insertAdjacentHTML('beforeend',
    `<label class="inline-flex items-center gap-1">
       <input id="${allId}" type="checkbox" class="w-4 h-4" checked> <span>全选</span>
     </label>`);
  document.getElementById(allId).addEventListener('change', e=>{
    const on=e.target.checked;
    host.querySelectorAll('input[type="checkbox"][data-shop]').forEach(cb=>cb.checked=on);
  });
  for(const name of allLabels){
    const id=`shop_${btoa(unescape(encodeURIComponent(name))).replace(/=/g,'')}`;
    host.insertAdjacentHTML('beforeend',
      `<label class="inline-flex items-center gap-1">
         <input id="${id}" data-shop type="checkbox" class="w-4 h-4" checked> <span>${esc(name)}</span>
       </label>`);
  }
  $('#avgHint').textContent = `（已载入门店：${allLabels.length}）`;
}
function getSelectedShopLabels(){
  const set=new Set();
  document.querySelectorAll('#shopChecks input[type="checkbox"][data-shop]').forEach(cb=>{
    if(cb.checked) set.add(cb.nextElementSibling?.textContent||'');
  });
  return set;
}

// 画图（禁用滚轮/触摸缩放；只用按钮触发）
function makeChart(ctx, datasets, showPoints){
  if(!ctx) return null;
  const dsLines = datasets.map(d=>({
    label:d.label, data:d.data, borderWidth:1, pointRadius: showPoints?2:0, spanGaps:true
  }));
  const selected = getSelectedShopLabels();
  const avgData = calcAvgSlot30(datasets, selected);
  const avgDataset = {
    label:'平均(选中门店)',
    data:avgData,
    borderColor:'#000', backgroundColor:'#000',
    borderWidth:3, pointRadius:0, spanGaps:true, order:0
  };

  const chart = new Chart(ctx, {
    type:'line',
    data:{ datasets:[...dsLines, ...( $('#toggleAvg').checked ? [avgDataset] : [] )] },
    options:{
      parsing:false, animation:false, normalized:true, spanGaps:true,
      interaction:{ mode:'index', intersect:false },
      plugins:{
        legend:{ position:'top' },
        tooltip:{ callbacks:{ label:(it)=>`${it.dataset.label}: ¥${Number(it.parsed.y).toLocaleString()}` } },
        zoom:{
          pan:{ enabled:true },                 // 不用拖拽平移
          zoom:{ wheel:{enabled:false}, pinch:{enabled:false} } // 不用滚轮/手势缩放
        }
      },
      scales:{
        x:{ type:'time', time:{ unit:'hour' }, title:{display:true,text:'记录时间'} },
        y:{ beginAtZero:false, title:{display:true,text:'价格（円）'} }
      },
      elements:{ line:{tension:0.2} }
    }
  });
  chart.__baseDatasets = datasets;
  return chart;
}
function destroyCharts(){ Object.values(charts).forEach(c=>c?.destroy()); charts={new:null,a:null,b:null}; }

// —— 按钮控制缩放/平移 —— //
// 给每张图先记录“数据域”的原始范围
function initDomain(c){
  if (!c || c.__domain) return;
  const base = c.__baseDatasets || [];
  const points = base.flatMap(ds => ds.data || []);
  const xs = points.map(p => p?.x).filter(v => typeof v === 'number' && !Number.isNaN(v));
  const ys = points.map(p => p?.y).filter(v => typeof v === 'number' && !Number.isNaN(v));
  if (!xs.length || !ys.length) return;

  const xMin = Math.min(...xs), xMax = Math.max(...xs);
  // 给 y 轴加一点边距（5%）
  const yMin0 = Math.min(...ys), yMax0 = Math.max(...ys);
  const pad = (yMax0 - yMin0) * 0.05;
  const yMin = yMin0 - pad;
  const yMax = yMax0 + pad;

  // 记录原始域
  c.__domain = { xMin, xMax, yMin, yMax };

  // 立即把 y 轴锁定为全域（之后不再改变）
  if (c.options.scales?.y) {
    c.options.scales.y.min = yMin;
    c.options.scales.y.max = yMax;
  }
}

// 读取当前可视范围（若未设置，就用原始域）
function getRange(c){
  const dom = c.__domain || {min: undefined, max: undefined};
  const s = c.options.scales?.x || {};
  let min = s.min ?? dom.min, max = s.max ?? dom.max;
  if (min == null || max == null || !(min < max)) {
    // 如果仍然不可用，退回到 Scale 的计算值
    const scale = c.scales?.x;
    if (scale) { min = scale.min; max = scale.max; }
  }
  return { min, max };
}

// 缩放：以当前中心为基准，按 factor 收缩/放大，并限制在原始域内
// 缩放：只动 x 轴范围
function zoomAll(factor){
  for (const c of Object.values(charts)) {
    if (!c) continue;
    initDomain(c);
    const dom = c.__domain; if (!dom) continue;

    // 当前可视范围
    const s = c.options.scales?.x || {};
    const curMin = (s.min ?? c.scales?.x?.min ?? dom.xMin);
    const curMax = (s.max ?? c.scales?.x?.max ?? dom.xMax);
    if (!(curMin < curMax)) continue;

    const mid = (curMin + curMax) / 2;
    const range = (curMax - curMin) / factor; // factor>1 → 放大
    let newMin = mid - range/2;
    let newMax = mid + range/2;

    // 限制在原始域内
    if (newMin < dom.xMin) { newMin = dom.xMin; newMax = dom.xMin + range; }
    if (newMax > dom.xMax) { newMax = dom.xMax; newMin = dom.xMax - range; }
    if (!(newMin < newMax)) { newMin = dom.xMin; newMax = dom.xMax; }

    c.options.scales.x.min = Math.floor(newMin);
    c.options.scales.x.max = Math.ceil(newMax);

    // 不改 y：保持 initDomain 时锁定的 y.min/y.max
    c.update('none');
  }
}


// 平移：按当前范围的百分比移动（frac：负数左移，正数右移）
function panAll(frac){
  for (const c of Object.values(charts)) {
    if (!c) continue;
    initDomain(c);
    const dom = c.__domain; if (!dom) continue;
    const r = getRange(c); if (!(r.min < r.max)) continue;
    const width = (r.max - r.min);
    const delta = width * frac;   // 例如 0.2 表示平移 20% 的宽度
    let newMin = r.min + delta;
    let newMax = r.max + delta;
    // 限制在原始域内
    if (newMin < dom.min) { newMin = dom.min; newMax = dom.min + width; }
    if (newMax > dom.max) { newMax = dom.max; newMin = dom.max - width; }
    c.options.scales.x.min = Math.floor(newMin);
    c.options.scales.x.max = Math.ceil(newMax);
    c.update('none');
  }
}

// 重置：清空 min/max，回到全域（或由 Scale 自己计算）
// 重置：x 回到全域；y 仍固定
function resetAllZoom(){
  for (const c of Object.values(charts)) {
    if (!c) continue;
    initDomain(c);
    const dom = c.__domain; if (!dom) continue;
    if (c.options.scales?.x) {
      c.options.scales.x.min = dom.xMin;
      c.options.scales.x.max = dom.xMax;
    }
    // y 保持 dom.yMin/dom.yMax，不做任何修改
    c.update('none');
  }
}
// 重置：x 回到全域；y 仍固定
function resetAllZoom(){
  for (const c of Object.values(charts)) {
    if (!c) continue;
    initDomain(c);
    const dom = c.__domain; if (!dom) continue;
    if (c.options.scales?.x) {
      c.options.scales.x.min = dom.xMin;
      c.options.scales.x.max = dom.xMax;
    }
    // y 保持 dom.yMin/dom.yMax，不做任何修改
    c.update('none');
  }
}

// 重新计算三张图的平均线
function recalcAverageOnCharts(){
  const showAvg = $('#toggleAvg').checked;
  const sel = getSelectedShopLabels();
  for(const key of ['new','a','b']){
    const chart = charts[key]; if(!chart) continue;
    chart.data.datasets = chart.data.datasets.filter(d=>d.label!=='平均(选中门店)');
    if(showAvg){
      const avgData = calcAvgSlot30(chart.__baseDatasets||[], sel);
      chart.data.datasets.push({
        label:'平均(选中门店)', data:avgData,
        borderColor:'#000', backgroundColor:'#000',
        borderWidth:3, pointRadius:0, spanGaps:true, order:0
      });
    }
    chart.update('none');
  }
}

// 拉数
async function fetchAllPriceSeries(pn, days){
  const recorded_after = toISODate(Date.now() - Math.max(1, days|0)*24*60*60*1000);
  const p = new URLSearchParams({ iphone_part_number: pn.trim(), recorded_after, ordering: 'recorded_at' });
  const rows = await fetchAll(`${apiBase}/purchasing-price-records/?${p.toString()}`);

  const metaBox = $('#pnMeta');
  if(rows.length){
    const first = rows.find(r => r.iphone_part_number) || rows[0];
    metaBox.innerHTML = `<span class="text-zinc-500">PN：</span><span class="font-mono">${esc(first.iphone_part_number||pn)}</span>
      <span class="ml-3 text-zinc-500">iPhone：</span>${esc(first.iphone_label||'')}`;
  } else {
    metaBox.textContent = '无数据';
  }

  const byShop=new Map(); // id -> { name, new:[], a:[], b:[] }
  for(const r of rows){
    const sid=r.shop;
    if(!byShop.has(sid)) byShop.set(sid,{ name:r.shop_name||`Shop #${sid}`, new:[], a:[], b:[] });
    const t=new Date(r.recorded_at).getTime();
    byShop.get(sid).new.push({x:t,y:r.price_new});
    byShop.get(sid).a.push({x:t,y:(r.price_grade_a??null)});
    byShop.get(sid).b.push({x:t,y:(r.price_grade_b??null)});
  }
  const shops=Array.from(byShop.values());
  return {
    shops,
    datasetsNew: shops.map(s=>({label:s.name,data:s.new})),
    datasetsA:   shops.map(s=>({label:s.name,data:s.a})),
    datasetsB:   shops.map(s=>({label:s.name,data:s.b})),
  };
}

// 运行流程
async function run(){
  const loading=$('#loading'); loading.classList.remove('hidden');
  try{
    const pn=($('#pnInput').value||'').trim();
    if(!pn) throw new Error('请输入 PN');
    const days=Math.max(1, parseInt($('#daysInput').value||'30',10));
    const showPoints=$('#showPoints').checked;

    const series=await fetchAllPriceSeries(pn, days);

    renderShopChecks(series.shops.map(s=>s.name));

    destroyCharts();
    charts.new = makeChart(document.getElementById('chart-new'), series.datasetsNew, showPoints);
    charts.a   = makeChart(document.getElementById('chart-a'),   series.datasetsA,   showPoints);
    charts.b   = makeChart(document.getElementById('chart-b'),   series.datasetsB,   showPoints);
[charts.new, charts.a, charts.b].forEach(c => initDomain(c));
    recalcAverageOnCharts();
  }catch(e){
    if(e==="未登录") return;
    destroyCharts();
    $('#pnMeta').textContent='';
    const wrapMsg = `<div class="p-3 rounded-lg bg-red-50 text-red-700">加载失败：${esc(e.message||e)}`;
    document.getElementById('chart-new').parentElement.insertAdjacentHTML('beforeend', wrapMsg);
  }finally{
    loading.classList.add('hidden');
  }
}

// 事件
$('#refreshBtn').addEventListener('click', run);
$('#recalcAvgBtn').addEventListener('click', recalcAverageOnCharts);
$('#toggleAvg').addEventListener('change', recalcAverageOnCharts);
$('#resetZoomBtn').addEventListener('click', resetAllZoom);
// 按钮缩放/平移：放大/缩小按 1.2/0.833，平移按 120px
$('#zoomInBtn').addEventListener('click', ()=> zoomAll(1.2));   // 放大
$('#zoomOutBtn').addEventListener('click', ()=> zoomAll(0.833)); // 缩小 ≈ 1/1.2
$('#panLeftBtn').addEventListener('click', ()=> panAll(-0.2));   // 向左平移 20%
$('#panRightBtn').addEventListener('click', ()=> panAll(0.2));   // 向右平移 20%
$('#pnInput').addEventListener('keydown', e=>{ if(e.key==='Enter') run(); });

// 初始化
(async function init(){
  // PN 下拉建议
  loadPnOptions();
})();
</script>
</body>
</html>
