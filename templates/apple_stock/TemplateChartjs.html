<!doctype html>
<html lang="zh">
<head>
    <meta charset="utf-8"/>
    <title>跨店铺曲线</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        :root {
            --w: 4080px;
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "PingFang SC", "Hiragino Sans", "Noto Sans CJK JP", Roboto, Arial;
            margin: 16px;
        }

        .wrap {
            max-width: var(--w);
            margin: 0 auto;

        }

        fieldset {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }

        legend {
            padding: 0 6px;
            color: #111827;
            font-weight: 600;
        }

        .row3 {
            display: grid;
            grid-template-columns: 1.2fr .9fr .9fr;
            gap: 10px;
        }

        .row4 {
            display: grid;
            grid-template-columns: .7fr .7fr .5fr .5fr;
            gap: 10px;
            max-width: 1500px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        label {
            font-size: 12px;
            color: #374151;
            display: block;
            margin-bottom: 6px;
        }

        input[type="text"], input[type="datetime-local"] {
            width: 80%;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            outline: none;
        }

        input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .15);
        }

        #shops {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 6px 10px;
            max-height: 180px;
            overflow: auto;
        }

        #shops label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btns {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            border: 0;
            padding: 9px 12px;
            border-radius: 10px;
            cursor: pointer;
            background: #111827;
            color: #fff;
        }

        button.secondary {
            background: #374151;
        }

        button.ghost {
            background: #f3f4f6;
            color: #111827;
        }

        #chart {
            width: 100%;
            height: 540px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
        }

        .muted {
            color: #6b7280;
            font-size: 12px;
        }

        .error {
            color: #b91c1c;
            font-size: 13px;
            margin-left: 8px;
        }

        .stat {
            font-size: 12px;
            white-space: pre-wrap;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 8px;
        }
    </style>
</head>
<body>
<div class="wrap">
    <h2 style="margin:6px 0 12px">店舗横断価格曲線</h2>


    <fieldset>
        <legend>選択条件</legend>
        <div class="row4">
            <div>
                <label>iPhoneの種類</label>
                <input id="iphone" list="iphone-list" type="text" placeholder="例：MG864J/A（プルダウンから選択可）"/>
                <div class="muted" id="iphone-hint" style="margin-top:4px">iPhone の候補を読み込み中…</div>
                <datalist id="iphone-list"></datalist>
            </div>

            <div>
                <label>iPhoneの型番（Part Number）</label>
                <input id="iphone" list="iphone-list" type="text" placeholder="例：MG864J/A（プルダウンから選択可）"/>
                <datalist id="iphone-list"></datalist>
                <div class="muted" id="iphone-hint" style="margin-top:4px">iPhone の候補を読み込み中…</div>
            </div>

            <div>
                <label>時間範囲 開始（JST）</label>
                <input id="start" type="datetime-local" step="60">
            </div>
            <div>
                <label>時間範囲 終了（JST）</label>
                <input id="end" type="datetime-local" step="60">
            </div>
        </div>

        <div style="margin-top:10px">
            <label>店舗</label>
            <div id="shops"></div>
            <div class="btns" style="margin-top:8px">
                <button class="ghost" id="select-all" type="button">すべて選択</button>
                <button class="ghost" id="clear-all" type="button">すべて解除</button>
            </div>
        </div>
    </fieldset>

    <div class="btns" style="margin:10px 0 8px">
        <button id="load" type="button">読み込み・描画</button>
        <button id="reset" class="secondary" type="button">表示をリセット</button>
        <span id="status" class="muted"></span><span id="err" class="error"></span>
    </div>

    <div id="chart"></div>

    <details style="margin-top:10px">
        <summary class="muted">デバッグ情報（店舗ごとの件数／フィルタ後件数／開始・終了時刻）</summary>
        <div id="stats" class="stat"></div>
    </details>
</div>


<script>
    /* ===================== 1) 固定颜色方案 ===================== */
    const LINE_PALETTE = [
        "#DD1133", /* 買取商店 */
        "#478CD8", /* 海峡通信 */
        "#B41524", /* 買取１丁目 */
        "#DD1133", /* モバイルミックス */
        "#278C46", /* 森森買取 */
        "#2DA9E8", /* 買取ルデヤ */
        "#E71534", /* 買取Wiki */
        "#F27474", /* 買取ホムラ */
        "#3952A6", /* ドラゴンモバイル- */
        "#E60012", /* モバステ- */
        "#20AECC", /* アキモバ- */
        "#0EC7D9", /* トゥインクル */
        "#FFF100", /* 家電市場-shop13 */
        "#DA7C66", /* 買取楽園-shop14 */
        "#1C4473", /* 買取当番-shop15 */
        "#0049A8", /* 携帯空間-shop16 */
        "#34C6F6", /* ゲストモバイル-shop17 */
        "#033F68", /* 買取オク-shop18 */
        /* #84cc16, 基础-19（保留空位） */
        "#C30D23", /* 毎日買取-shop20 */
    ];

    // 名称→固定色（模糊匹配），其余回退到调色板序号
    const SHOP_COLOR_RULES = [
        {match: /アキモバ/, color: "#20AECC"},
        {match: /トゥインクル/, color: "#0EC7D9"},
        {match: /モバイルミックス/, color: "#DD1133"},
        {match: /森森買取/, color: "#278C46"},
        {match: /ルデヤ/, color: "#2DA9E8"},
        {match: /ホムラ/, color: "#F27474"},
        {match: /ドラゴンモバイル/, color: "#3952A6"},
        {match: /モバステ/, color: "#E60012"},
        {match: /家電市場/, color: "#FFF100"},
        {match: /買取楽園/, color: "#DA7C66"},
        {match: /買取当番/, color: "#1C4473"},
        {match: /携帯空間/, color: "#0049A8"},
        {match: /ゲストモバイル/, color: "#34C6F6"},
        {match: /買取オク/, color: "#033F68"},
        {match: /毎日買取/, color: "#C30D23"},
        {match: /海峡通信/, color: "#478CD8"},
        {match: /買取１丁目/, color: "#B41524"},
        {match: /買取商店/, color: "#DD1133"},
        {match: /買取Wiki/, color: "#E71534"},
    ];

    function fixedColorFor(seriesName, indexFallback) {
        for (const rule of SHOP_COLOR_RULES) {
            if (rule.match.test(seriesName)) return rule.color;
        }
        return LINE_PALETTE[indexFallback % LINE_PALETTE.length];
    }

    const $ = id => document.getElementById(id);
    const fmtJPY = n => new Intl.NumberFormat('ja-JP', {
        style: 'currency',
        currency: 'JPY',
        maximumFractionDigits: 0
    }).format(n);
    const fmtJST = ts => new Date(ts).toLocaleString('ja-JP', {hour12: false});
    const WDAY = ['日', '月', '火', '水', '木', '金', '土'];

    /* ====== 常量：时间序列 API & SSE 路径 ====== */
    const SERIES_API_BASE = '/AppleStockChecker/purchasing-time-analyses/psta-compact/'; // ← 如需调整，改这条
    const BROADCAST_URL = '/events/notify_progress_all';                                  // SSE 路径

    /* ====== 运行态索引与状态 ====== */
    const SHOPS_INDEX = new Map();        // shopId -> shopName
    const IPHONE_ID_BY_PART = new Map();  // part_number -> iphone_id
    let ACTIVE_PART_NUMBER = '';
    let ACTIVE_IPHONE_ID = null;          // 当前选择的机型 id（来自 IPHONE_ID_BY_PART）
    let SELECTED_SHOP_IDS = new Set();    // 当前勾选的门店
    let liveES = null;

    function toIsoLocal(dtStr) {
        return dtStr ? dtStr + ":00+09:00" : "";
    }

    function toMillis(s) {
        const t = new Date(s).valueOf();
        return Number.isFinite(t) ? t : NaN;
    }

    function nearestPastMinuteMs(date = new Date()) {
        return Math.floor(date.getTime() / 60000) * 60000;
    }

    function buildURL(base, startIsoJST, endIsoJST, shopId, partNumber) {
        const u = new URL(base, location.origin);
        u.searchParams.set("start", startIsoJST);
        u.searchParams.set("end", endIsoJST);
        u.searchParams.set("shop", String(shopId));                 // 如后端要求 shop_id，这里改成 "shop_id"
        u.searchParams.set("iphone__part_number", String(partNumber));
        return u.toString();
    }

    /* ============ 3) X 轴标签：竖排（月/日/（周）） ============ */
    function verticalTickFormatter(value /* ms */) {
        const d = new Date(value);
        const m = d.getMonth() + 1;
        const day = d.getDate();
        const w = WDAY[d.getDay()];
        return `${m}\n月\n${day}日\n（${w}）`;
    }

    /* ============ 4) 每天 9:00–20:00 markArea 背景（保留） ============ */
    function buildBusinessHoursMarkArea(startMs, endMs) {
        const oneDay = 24 * 3600 * 1000;
        const data = [];
        let d = new Date(startMs);
        d.setHours(0, 0, 0, 0);
        for (let t = d.valueOf(); t <= endMs + oneDay; t += oneDay) {
            const s = new Date(t);
            const s9 = new Date(s);
            s9.setHours(9, 0, 0, 0);
            const e20 = new Date(s);
            e20.setHours(20, 0, 0, 0);
            const s9ms = s9.valueOf(), e20ms = e20.valueOf();
            const left = Math.max(s9ms, startMs);
            const right = Math.min(e20ms, endMs);
            if (left < right) data.push([{xAxis: left}, {xAxis: right}]);
        }
        return {silent: true, itemStyle: {color: '#faebd7', opacity: 0.35}, data};
    }

    // --- ECharts ---
    const chart = echarts.init($('chart'));
    const baseOption = {
        animation: false,
        tooltip: {show: true, trigger: 'axis'},
        legend: {top: 8, left: 10, itemGap: 14},
        grid: {left: 16, right: 48, top: 40, bottom: 12},
        xAxis: {
            type: 'time',
            axisLabel: {formatter: verticalTickFormatter, lineHeight: 16, margin: 18},
            axisTick: {alignWithLabel: true}
        },
        yAxis: {type: 'value', position: 'right', name: 'JPY', scale: true},
        dataZoom: [
            {type: 'inside', xAxisIndex: [0]},
            {type: 'slider', xAxisIndex: [0], bottom: -2, height: 12, handleSize: 0}
        ],
        series: []
    };
    chart.setOption(baseOption);
    $('reset').addEventListener('click', () => chart.setOption(baseOption, true));
    window.addEventListener('resize', () => chart.resize());

    const API_BASE = '/AppleStockChecker';
    const ENDPOINT_SHOPS = `${API_BASE}/secondhand-shops/`;
    const ENDPOINT_IPHONES = `${API_BASE}/iphones/`;

    async function loadShops() {
        const box = $('shops');
        box.innerHTML = '';
        SHOPS_INDEX.clear();
        try {
            const resp = await fetch(ENDPOINT_SHOPS);
            const items = await resp.json();
            for (const s of items) {
                const id = `shop_${s.id}`;
                const label = document.createElement('label');
                label.title = s.name;
                label.innerHTML = `<input type="checkbox" value="${s.id}" data-name="${s.name}" id="${id}"><span>${s.name}</span>`;
                box.appendChild(label);
                SHOPS_INDEX.set(Number(s.id), s.name); // 索引
            }
        } catch (e) {
            $('err').textContent = '店舗の読み込みに失敗しました（CORSまたはネットワーク）';
        }
    }

    // —— 更健壮的 loadShops —— //
    async function loadShops() {
        const box = $('shops');
        box.innerHTML = '';
        SHOPS_INDEX.clear();

        try {
            const resp = await fetch(ENDPOINT_SHOPS);
            if (!resp.ok) {
                const txt = await resp.text().catch(() => '');
                throw new Error(`HTTP ${resp.status} ${resp.statusText} ${txt.slice(0, 200)}`);
            }
            const payload = await resp.json();

            // 兼容数组 / results / items
            const items = Array.isArray(payload) ? payload
                : Array.isArray(payload?.results) ? payload.results
                    : Array.isArray(payload?.items) ? payload.items
                        : [];

            let invalidCount = 0;

            for (const s of items) {
                // 尝试多种 id 字段名
                const sidRaw = s?.id ?? s?.shop_id ?? s?.pk ?? s?.ID ?? s?.Id;
                const sid = Number(sidRaw);
                if (!Number.isFinite(sid)) {
                    invalidCount++;
                    // 调试：在控制台看到是哪条数据有问题
                    console.warn('[shops] skip invalid id item:', s);
                    continue; // 跳过没有有效 id 的项
                }

                // 名称字段也容错
                const sname = s?.name ?? s?.shop_name ?? s?.display_name ?? String(sid);

                // 用 DOM API 安全构建（避免 innerHTML 把 undefined 拼进去）
                const label = document.createElement('label');
                label.title = sname;

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = String(sid);
                input.dataset.name = sname;
                input.dataset.shopId = String(sid);        // ★ 关键：标记有效门店
                input.id = `shop_${sid}`;

                const span = document.createElement('span');
                span.textContent = sname;

                label.appendChild(input);
                label.appendChild(span);
                box.appendChild(label);

                SHOPS_INDEX.set(sid, sname);
            }

            if (items.length === 0) {
                $('err').textContent = '店舗リストが空です（API 応答を確認してください）';
            }
            if (invalidCount > 0) {
                // 仅提示，不阻断
                console.warn(`[shops] skipped ${invalidCount} invalid entries (missing id)`);
            }
        } catch (e) {
            console.error(e);
            $('err').textContent = '店舗の読み込みに失敗しました（CORS / 認証 / 応答形式を確認）';
        }
    }

    // —— 仅选/清 有效门店（带 data-shop-id） —— //
    $('select-all').addEventListener('click', () => {
        document.querySelectorAll('#shops input[type=checkbox][data-shop-id]').forEach(cb => cb.checked = true);
    });
    $('clear-all').addEventListener('click', () => {
        document.querySelectorAll('#shops input[type=checkbox][data-shop-id]').forEach(cb => cb.checked = false);
    });

    // ---- 取数（带埋点 & 可选鉴权） ----
    async function fetchOneShopSeries(base, startIsoJST, endIsoJST, shopId, shopName, partNumber) {
        const url = buildURL(base, startIsoJST, endIsoJST, shopId, partNumber);
        console.debug('[FETCH]', url);
        const headers = {"Accept": "application/json"};
        const token = localStorage.getItem('iphone:token'); // 如有鉴权，放入本地存储
        if (token) headers["Authorization"] = `Bearer ${token}`;

        const resp = await fetch(url, {headers});
        let rawText = '';
        if (!resp.ok) {
            try {
                rawText = await resp.text();
            } catch (_) {
            }
            throw new Error(`HTTP ${resp.status} ${resp.statusText} | ${rawText.slice(0, 200)}`);
        }

        // 兼容包裹层
        let payload = await resp.json();
        const data = Array.isArray(payload) ? payload
            : Array.isArray(payload?.results) ? payload.results
                : Array.isArray(payload?.items) ? payload.items
                    : [];

        // 字段名兜底（驼峰/蛇形/别名）
        const pick = (r, kList) => kList.find(k => k in r) ?? kList[0];
        const tKey = data[0] ? pick(data[0], ["Timestamp_Time", "timestamp_time", "timestamp", "ts", "t"]) : "Timestamp_Time";
        const pKey = data[0] ? pick(data[0], ["New_Product_Price", "new_product_price", "price", "value"]) : "New_Product_Price";
        const pnKey = data[0] ? pick(data[0], ["iphone", "iphone__part_number", "part_number"]) : "iphone";

        const rows = data.filter(r => !r[pnKey] || r[pnKey] === partNumber);

        const seriesData = rows
            .map(r => [new Date(r[tKey]).valueOf(), Number(r[pKey])])
            .filter(p => Number.isFinite(p[0]) && Number.isFinite(p[1]))
            .sort((a, b) => a[0] - b[0]);

        const firstT = seriesData[0]?.[0];
        const lastT = seriesData[seriesData.length - 1]?.[0];

        return {
            name: shopName,
            data: seriesData,
            stat: {shopId, shopName, returned: data.length, filtered: rows.length, firstT, lastT, url}
        };
    }

    // ---- 影子点：把最后一个点拉到最近整数分钟 ----
    function appendShadowToNowIfNeeded(seriesData) {
        if (!seriesData.length) return seriesData;
        const last = seriesData[seriesData.length - 1];
        const nowMin = nearestPastMinuteMs();
        if (last[0] < nowMin) {
            const hasNow = seriesData.length && (
                (Array.isArray(seriesData[seriesData.length - 1]) && seriesData[seriesData.length - 1][0] === nowMin) ||
                (seriesData[seriesData.length - 1]?.value?.[0] === nowMin)
            );
            if (!hasNow) {
                seriesData.push({
                    value: [nowMin, last[1]],
                    symbol: 'emptyCircle',
                    symbolSize: 6,
                    shadow: true,
                    src_ts: last[0]
                });
            }
        }
        return seriesData;
    }

    // ---- SSE：实时增量 ----
    function connectLive() {
        if (liveES) try {
            liveES.close();
        } catch (_) {
        }
        try {
            liveES = new EventSource(BROADCAST_URL, {withCredentials: true});
            liveES.onmessage = ev => {
                try {
                    const msg = JSON.parse(ev.data);
                    onBroadcast(msg);
                } catch (e) {
                    console.error('SSE parse error', e);
                }
            };
            liveES.onerror = err => console.warn('SSE error', err);
        } catch (e) {
            console.warn('EventSource not available:', e);
        }
    }

    function onBroadcast(msg) {
        if (msg?.status === 'running') {
            // 可选：显示进度
            $('status').textContent = `処理中… ${msg.timestamp} / バケット: ${msg.buckets}`;
            return;
        }
        if (msg?.status === 'done' && msg?.chart_delta?.series_delta) {
            applyChartDelta(msg.chart_delta);
        } else if (msg?.type === 'chart_update' && msg?.series_delta) {
            applyChartDelta(msg); // 如果你在子任务阶段也做了中间广播
        }
    }

    function ensureSeriesByShop(shopId, name) {
        const id = `s:${shopId}`;
        const opt = chart.getOption();
        const arr = opt.series || [];
        if (arr.findIndex(s => s.id === id) >= 0) return id;

        const color = fixedColorFor(name, arr.length);
        arr.push({
            id, name,
            type: 'line',
            showSymbol: false,
            smooth: 0.15,
            emphasis: {focus: 'series'},
            lineStyle: {width: 2, color},
            itemStyle: {color},
            data: []
        });
        chart.setOption({series: arr, legend: {data: arr.map(s => s.name)}});
        return id;
    }

    function applyChartDelta(delta) {
        if (!delta || !Array.isArray(delta.series_delta)) return;

        const touched = [];

        for (const sd of delta.series_delta) {
            // ★ 仅接收当前选择的 iPhone（patch 1/3）
            if (ACTIVE_IPHONE_ID && Number(sd.iphone_id) !== Number(ACTIVE_IPHONE_ID)) continue;

            const shopId = Number(sd.shop_id);
            if (!SELECTED_SHOP_IDS.has(shopId)) continue; // 仅更新当前勾选的门店

            const shopName = SHOPS_INDEX.get(shopId) || `#${shopId}`;
            const id = ensureSeriesByShop(shopId, shopName);

            const opt = chart.getOption();
            const seriesArr = opt.series || [];
            const idx = seriesArr.findIndex(s => s.id === id);
            const cur = (idx >= 0 ? seriesArr[idx].data : []) || [];

            // 建立 ts->索引 的索引，并标记是否是影子点
            const indexByTs = new Map();
            cur.forEach((item, i) => {
                const v = Array.isArray(item) ? item : item?.value;
                const t = Array.isArray(v) ? v[0] : undefined;
                const isShadow = !!(item && item.shadow === true);
                if (Number.isFinite(t)) indexByTs.set(t, {idx: i, isShadow});
            });

            const patch = cur.slice();

            for (const p of (sd.points || [])) {
                const t = toMillis(p.t);
                const y = Number(p.price);
                if (!Number.isFinite(t) || !Number.isFinite(y)) continue;

                const curAtT = indexByTs.get(t);
                if (p.shadow) {
                    if (curAtT && !curAtT.isShadow) continue; // 有真实点就忽略影子
                    const item = {
                        value: [t, y],
                        symbol: 'emptyCircle',
                        symbolSize: 6,
                        shadow: true,
                        src_ts: p.src_t || null
                    };
                    if (curAtT) patch[curAtT.idx] = item; else {
                        indexByTs.set(t, {idx: patch.length, isShadow: true});
                        patch.push(item);
                    }
                } else {
                    const item = [t, y]; // 真实点用数组，渲染更快
                    if (curAtT) {
                        patch[curAtT.idx] = item;
                        indexByTs.set(t, {idx: curAtT.idx, isShadow: false});
                    } else {
                        indexByTs.set(t, {idx: patch.length, isShadow: false});
                        patch.push(item);
                    }
                    // 确保把同刻影子移掉（如果有）
                    const shadowIdx = patch.findIndex(x => !Array.isArray(x) && x?.shadow === true && x?.value?.[0] === t);
                    if (shadowIdx >= 0) patch.splice(shadowIdx, 1);
                }
            }

            patch.sort((a, b) => {
                const va = Array.isArray(a) ? a : a.value;
                const vb = Array.isArray(b) ? b : b.value;
                return va[0] - vb[0];
            });
            if (patch.length > MAX_POINTS_PER_SERIES) patch.splice(0, patch.length - MAX_POINTS_PER_SERIES);

            chart.setOption({series: [{id, data: patch}]}, {notMerge: false, lazyUpdate: true});
            touched.push(id);
        }
    }

    function putStats(stats) {
        const div = $('stats');
        const lines = stats.map(s => {
            const t0 = s.firstT ? new Date(s.firstT).toLocaleString() : '-';
            const t1 = s.lastT ? new Date(s.lastT).toLocaleString() : '-';
            return `#${s.shopId} ${s.shopName}\n  取得件数: ${s.returned}\n  フィルタ後の点数: ${s.filtered}\n  開始/終了時刻: ${t0}  →  ${t1}\n  URL: ${s.url}\n`;
        });
        div.textContent = lines.join('\n');
    }

    async function loadAndPlot() {
        $('status').textContent = '読み込み中…';
        $('err').textContent = '';
        $('stats').textContent = '';

        const base = SERIES_API_BASE; // ★ 不再依赖 $('base')，固定你的序列 API
        const part = $('iphone').value.trim();
        const startIso = toIsoLocal($('start').value);
        const endIso = toIsoLocal($('end').value);

        if (!base || !startIso || !endIso) {
            $('err').textContent = 'ベースURLと時間範囲を入力してください';
            $('status').textContent = '';
            return;
        }
        if (!part) {
            $('err').textContent = 'part_number を入力してください';
            $('status').textContent = '';
            return;
        }

        const shopCbs = Array.from(
            document.querySelectorAll('#shops input[type=checkbox][data-shop-id]:checked')
        ).filter(cb => /^\d+$/.test(String(cb.value)));
        if (shopCbs.length === 0) {
            $('err').textContent = '少なくとも1店舗を選択してください';
            $('status').textContent = '';
            return;
        }

        // ★ 记录活动条件（patch 2/3）
        ACTIVE_PART_NUMBER = part;
        ACTIVE_IPHONE_ID = IPHONE_ID_BY_PART.get(part) ?? null;
        SELECTED_SHOP_IDS = new Set(shopCbs.map(cb => Number(cb.value)));

        try {
            const tasks = shopCbs.map(cb => {
                const id = cb.value;
                const name = cb.getAttribute('data-name') || id;
                return fetchOneShopSeries(base, startIso, endIso, id, name, part)
                    .then(r => ({ok: true, r}))
                    .catch(e => ({ok: false, name, e}));
            });

            const results = await Promise.all(tasks);
            const series = [];
            const failed = [];
            const stats = [];

            let idxFallback = 0;
            for (const it of results) {
                if (it.ok) {
                    stats.push(it.r.stat);
                    const shopIdNum = Number(it.r.stat.shopId);
                    const name = it.r.name;
                    const color = fixedColorFor(name, idxFallback++);

                    // ★ 首屏：若最后点早于最近整数分钟，补一个影子点（patch 3/3）
                    const data = appendShadowToNowIfNeeded(it.r.data.slice());

                    series.push({
                        id: `s:${shopIdNum}`,     // 稳定 id，方便后续增量定点刷新
                        name,
                        type: 'line',
                        showSymbol: false,
                        smooth: 0.15,
                        emphasis: {focus: 'series'},
                        lineStyle: {width: 2, color},
                        itemStyle: {color},
                        data
                    });
                } else {
                    failed.push(it.name);
                }
            }

            putStats(stats);

            const anyPoints = series.some(s => s.data.length > 0);
            const subTitle = `iPhone：${part} ｜ ${new Date(startIso).toLocaleString()} → ${new Date(endIso).toLocaleString()}`;

            if (!anyPoints) {
                chart.clear();
                chart.setOption({
                    title: {text: 'データなし', subtext: subTitle, left: 'center', top: 'middle'}
                });
                $('status').textContent = 'データがありません。part_number と時間範囲が選択した店舗の記録をカバーしているか確認してください。';
                return;
            }

            chart.setOption({
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {type: 'cross'},
                    formatter: function (params) {
                        if (!params || !params.length) return '';
                        const head = new Date(params[0].axisValue).toLocaleString('ja-JP', {hour12: false});
                        const lines = [head];
                        for (const p of params) {
                            const v = Array.isArray(p.value) ? p.value[1] : (p.data?.value?.[1] ?? p.value);
                            const isShadow = p.data && p.data.shadow === true;
                            let line = `${p.seriesName}: ${fmtJPY(v)}`;
                            if (isShadow) {
                                const src = p.data.src_ts ? new Date(p.data.src_ts).toLocaleString('ja-JP', {hour12: false}) : '';
                                line += src ? `（影子 ← ${src}）` : `（影子）`;
                            }
                            lines.push(line);
                        }
                        return lines.join('<br>');
                    }
                },
                toolbox: {show: true, feature: {saveAsImage: {}}},
                legend: {data: series.map(s => s.name)},
                xAxis: {
                    type: 'time',
                    axisLabel: {formatter: verticalTickFormatter, lineHeight: 16, margin: 18},
                    axisTick: {alignWithLabel: true}
                },
                yAxis: {
                    type: 'value',
                    position: 'right',
                    name: 'JPY',
                    scale: true
                },
                series
            }, true);

            $('status').textContent = `完了：${series.length} 店舗${failed.length ? `／失敗：${failed.join(', ')}` : ''}`;
        } catch (e) {
            $('err').textContent = '読み込みに失敗しました：' + e.message;
            $('status').textContent = '';
            console.error(e);
        }
    }

    $('load').addEventListener('click', loadAndPlot);

    (function initDefaults() {
        $('start').value = "2025-10-11T09:00";
        $('end').value = "2025-10-11T20:00";
        loadShops();
        loadIphones();
        $('iphone').placeholder = "例：MG864J/A";
        connectLive(); // 开启 SSE 订阅
    })();
</script>
</body>
</html>
